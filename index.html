<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>TheLamaNest ‚Äì Comparador IA</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta
      name="description"
      content="Comparador IA de TheLamaNest: elige dos productos que ya tengan meta-review y deja que el Lama sabio te ayude a decidir."
    />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD + Babel para JSX en el navegador -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        background: #fff7ed; /* naranja muy claro */
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
      }

      html {
        scroll-behavior: smooth;
      }

      .fade-in {
        animation: fade-in 0.4s ease-out;
      }

      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // --- Componentes auxiliares ---

      function LlamaBadge() {
        return (
          <div className="w-16 h-16 rounded-2xl bg-amber-200 flex items-center justify-center shadow-sm">
            <span className="text-3xl">ü¶ô</span>
          </div>
        );
      }

      function ProductMiniCard({ product }) {
        if (!product) return null;

        return (
          <div className="mt-3 border border-amber-200 bg-amber-50/60 rounded-xl p-3 text-sm fade-in">
            <div className="font-semibold text-slate-900 mb-1 line-clamp-2">
              {product.nombre_producto}
            </div>
            <div className="flex flex-wrap items-center gap-2 text-xs text-slate-500 mb-2">
              <span>ASIN: {product.asin}</span>
              <span className="inline-block w-1 h-1 rounded-full bg-slate-300"></span>
              <span>{product.market}</span>
              {product.categoria_inferida && (
                <>
                  <span className="inline-block w-1 h-1 rounded-full bg-slate-300"></span>
                  <span>{product.categoria_inferida}</span>
                </>
              )}
            </div>
            <div className="flex items-center gap-2 text-xs text-slate-600">
              <span className="font-semibold">
                {product.mean_stars?.toFixed
                  ? product.mean_stars.toFixed(1)
                  : product.mean_stars}{" "}
                ‚òÖ
              </span>
              {product.n_reviews && (
                <span className="text-slate-500">
                  ({product.n_reviews.toLocaleString("es-ES")} rese√±as)
                </span>
              )}
            </div>
            {product.tags_tematica && product.tags_tematica.length > 0 && (
              <div className="mt-2 flex flex-wrap gap-1">
                {product.tags_tematica.slice(0, 4).map((tag) => (
                  <span
                    key={tag}
                    className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 text-[11px] font-medium"
                  >
                    #{tag}
                  </span>
                ))}
              </div>
            )}
          </div>
        );
      }

      function SuggestionsList({ items, onSelect }) {
        if (!items || items.length === 0) return null;

        return (
          <div className="absolute z-20 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-lg max-h-56 overflow-auto text-sm">
            {items.map((p) => (
              <button
                key={p.asin}
                type="button"
                className="w-full text-left px-3 py-2 hover:bg-amber-50"
                onClick={() => onSelect(p)}
              >
                <div className="font-medium text-slate-900 line-clamp-1">
                  {p.nombre_producto}
                </div>
                <div className="text-[11px] text-slate-500">
                  ASIN: {p.asin} ¬∑ {p.mean_stars ?? "?"}‚òÖ ¬∑{" "}
                  {p.categoria_inferida || "‚Äî"}
                </div>
              </button>
            ))}
          </div>
        );
      }

      function ProductSelector({
        slot,
        catalog,
        selectedProduct,
        asinValue,
        onChangeAsin,
        onSelectProduct,
      }) {
        const [query, setQuery] = useState("");
        const [suggestions, setSuggestions] = useState([]);

        useEffect(() => {
          if (!query || query.trim().length < 3 || !catalog.length) {
            setSuggestions([]);
            return;
          }
          const q = query.toLowerCase();
          const results = catalog.filter((p) =>
            (p.nombre_producto || "").toLowerCase().includes(q)
          );
          setSuggestions(results.slice(0, 7));
        }, [query, catalog]);

        const handleSelect = (product) => {
          onSelectProduct(product);
          onChangeAsin(product.asin);
          setQuery(product.nombre_producto);
          setSuggestions([]);
        };

        const handleUseAsinClick = () => {
          const asin = (asinValue || "").trim();
          if (!asin) return;
          if (!catalog.length) return;

          const product = catalog.find(
            (p) => (p.asin || "").toUpperCase() === asin.toUpperCase()
          );
          if (!product) {
            alert(
              "No encontramos ese ASIN en el √≠ndice Lama. Revisa el c√≥digo o a√±ade el producto a lama_index.json."
            );
            return;
          }
          onSelectProduct(product);
        };

        return (
          <div className="bg-white border border-amber-200/70 rounded-2xl p-4 md:p-5 shadow-sm">
            <div className="flex items-center gap-2 mb-3">
              <div className="w-6 h-6 rounded-full bg-amber-500 text-white text-xs flex items-center justify-center font-bold">
                {slot}
              </div>
              <h2 className="font-semibold text-slate-900">Producto {slot}</h2>
            </div>

            <div className="space-y-3 text-sm">
              <div className="relative">
                <label className="block text-xs font-medium text-slate-500 mb-1">
                  Busca por nombre, marca o modelo
                </label>
                <div className="relative">
                  <span className="absolute left-3 top-2.5 text-slate-300">
                    üîç
                  </span>
                  <input
                    type="text"
                    className="w-full pl-8 pr-3 py-2 rounded-lg bg-amber-50 border border-amber-100 focus:outline-none focus:ring-2 focus:ring-amber-300 focus:bg-white text-sm"
                    placeholder="Ej: Oral-B Pro 3..."
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === "Enter") {
                        e.preventDefault();
                        if (suggestions.length > 0) {
                          handleSelect(suggestions[0]); // selecciona el primer sugerido
                        }
                      }
                    }}
                  />
                </div>
                <SuggestionsList items={suggestions} onSelect={handleSelect} />
              </div>

              <div className="flex flex-col gap-1">
                <label className="block text-xs font-medium text-slate-500">
                  ¬øVienes de Amazon o ya conoces el c√≥digo?
                </label>
                <div className="flex gap-2">
                  <input
                    type="text"
                    className="flex-1 px-3 py-2 rounded-lg bg-amber-50 border border-amber-100 focus:outline-none focus:ring-2 focus:ring-amber-300 focus:bg-white text-sm"
                    placeholder="Ej: B0CLRYN7BX"
                    value={asinValue}
                    onChange={(e) => onChangeAsin(e.target.value.toUpperCase())}
                  />
                  <button
                    type="button"
                    onClick={handleUseAsinClick}
                    className="px-3 py-2 rounded-lg bg-slate-900 text-white text-xs font-semibold hover:bg-black transition-colors"
                  >
                    Usar ASIN
                  </button>
                </div>
              </div>

              <div className="text-xs text-slate-500">
                {selectedProduct ? (
                  <span>Producto seleccionado:</span>
                ) : (
                  <span>Todav√≠a no has seleccionado ning√∫n producto.</span>
                )}
              </div>

              <ProductMiniCard product={selectedProduct} />
            </div>
          </div>
        );
      }

      function StarsRow({ product }) {
        if (!product || !product.stars_pct) return <span>‚Äî</span>;
        const pct = product.stars_pct;
        const order = ["5", "4", "3", "2", "1"];
        return (
          <div className="space-y-1 text-xs">
            {order.map((k) => {
              if (pct[k] == null) return null;
              const value = pct[k] * 100;
              return (
                <div key={k} className="flex items-center gap-2">
                  <span className="w-6 text-right font-medium">{k}‚òÖ</span>
                  <div className="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-amber-400"
                      style={{ width: `${Math.min(100, value)}%` }}
                    ></div>
                  </div>
                  <span className="w-9 text-right text-slate-600">
                    {value.toFixed(0)}%
                  </span>
                </div>
              );
            })}
          </div>
        );
      }

      function BulletList({ items, tone }) {
        if (!items || !items.length) return <span className="text-xs">‚Äî</span>;
        const base =
          "inline-flex items-center px-2 py-0.5 rounded-full text-[11px] mr-1 mb-1";
        const ok =
          "bg-emerald-50 text-emerald-800 border border-emerald-100";
        const bad = "bg-rose-50 text-rose-800 border border-rose-100";
        const cls = tone === "bad" ? bad : ok;

        return (
          <div className="flex flex-wrap">
            {items.map((it) => (
              <span key={it} className={base + " " + cls}>
                {it}
              </span>
            ))}
          </div>
        );
      }

      // --- Componente principal App ---

      function App() {
        const [catalog, setCatalog] = useState([]);
        const [catalogStatus, setCatalogStatus] = useState("loading"); // loading | ready | error
        const [catalogError, setCatalogError] = useState("");

        const [selected1, setSelected1] = useState(null);
        const [selected2, setSelected2] = useState(null);
        const [asin1, setAsin1] = useState("");
        const [asin2, setAsin2] = useState("");

        const [metricsStatus, setMetricsStatus] = useState("idle"); // idle | loading | success | error
        const [metricsError, setMetricsError] = useState("");
        const [metricsData, setMetricsData] = useState(null);

        const [narrativeStatus, setNarrativeStatus] = useState("idle"); // idle | loading | success | error
        const [narrativeError, setNarrativeError] = useState("");
        const [narrativeText, setNarrativeText] = useState("");

        // Cargar √≠ndice desde la funci√≥n Netlify (GET con query, como espera el backend)
        useEffect(() => {
          async function loadIndex() {
            try {
              setCatalogStatus("loading");
              const res = await fetch(
                "/.netlify/functions/verifymyth?mode=index"
              );
              const data = await res.json();
              if (!data.success) {
                throw new Error(data.error || "Error al cargar el √≠ndice.");
              }
              setCatalog(data.products || []);
              setCatalogStatus("ready");
            } catch (err) {
              console.error(err);
              setCatalogStatus("error");
              setCatalogError(err.message);
            }
          }
          loadIndex();
        }, []);

        const canCompare =
          selected1 &&
          selected2 &&
          selected1.asin &&
          selected2.asin &&
          selected1.asin !== selected2.asin;

        const handleCompareClick = async () => {
          if (!canCompare) return;
          setMetricsStatus("loading");
          setMetricsError("");
          setMetricsData(null);
          setNarrativeStatus("idle");
          setNarrativeText("");
          setNarrativeError("");

          try {
            const res = await fetch("/.netlify/functions/verifymyth", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                mode: "metrics",
                asinA: selected1.asin,
                asinB: selected2.asin,
              }),
            });
            const data = await res.json();
            if (!data.success) {
              throw new Error(data.error || "Error en comparativa de datos.");
            }

            const [pA, pB] = data.products || [];
            setMetricsData({
              productA: pA,
              productB: pB,
              analysis: data.analysis || "",
            });
            setMetricsStatus("success");
          } catch (err) {
            console.error(err);
            setMetricsStatus("error");
            setMetricsError(err.message);
          }
        };

        const handleNarrativeClick = async () => {
          if (!canCompare || metricsStatus !== "success") return;
          setNarrativeStatus("loading");
          setNarrativeError("");
          setNarrativeText("");

          try {
            const res = await fetch("/.netlify/functions/verifymyth", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                mode: "narrative",
                asinA: selected1.asin,
                asinB: selected2.asin,
              }),
            });
            const data = await res.json();
            if (!data.success) {
              throw new Error(
                data.error || "Error generando la opini√≥n de la IA."
              );
            }
            setNarrativeText(data.text || "");
            setNarrativeStatus("success");
          } catch (err) {
            console.error(err);
            setNarrativeStatus("error");
            setNarrativeError(err.message);
          }
        };

        return (
          <div className="min-h-screen">
            <main className="max-w-5xl mx-auto px-4 py-10 md:py-16">
              {/* Cabecera */}
              <header className="mb-10 md:mb-12 text-center">
                <div className="flex justify-center mb-4">
                  <LlamaBadge />
                </div>
                <h1 className="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 mb-2">
                  El comparador IA de TheLamaNest
                </h1>
                <p className="text-sm md:text-base text-slate-600 max-w-2xl mx-auto">
                  Elige dos productos que ya tengan meta-review en TheLamaNest,
                  comp√°ralos con datos reales de rese√±as y deja que el Lama
                  sabio te ayude a decidir cu√°l encaja mejor contigo.
                </p>

                {catalogStatus === "loading" && (
                  <p className="mt-3 text-xs text-slate-500">
                    Cargando √≠ndice Lama...
                  </p>
                )}
                {catalogStatus === "error" && (
                  <p className="mt-3 text-xs text-red-600">
                    No se pudo cargar el √≠ndice: {catalogError}
                  </p>
                )}
              </header>

              {/* Selecci√≥n de productos */}
              <section className="bg-amber-50/70 border border-amber-200 rounded-3xl p-4 md:p-6 mb-8">
                <div className="grid md:grid-cols-2 gap-4 md:gap-6">
                  <ProductSelector
                    slot={1}
                    catalog={catalog}
                    selectedProduct={selected1}
                    asinValue={asin1}
                    onChangeAsin={setAsin1}
                    onSelectProduct={setSelected1}
                  />
                  <ProductSelector
                    slot={2}
                    catalog={catalog}
                    selectedProduct={selected2}
                    asinValue={asin2}
                    onChangeAsin={setAsin2}
                    onSelectProduct={setSelected2}
                  />
                </div>

                <p className="mt-4 text-xs text-slate-500 text-center">
                  Selecciona dos productos distintos para activar los botones de
                  IA.
                </p>

                {/* Botones IA */}
                <div className="mt-5 flex flex-col md:flex-row gap-3 justify-center">
                  <button
                    type="button"
                    onClick={handleCompareClick}
                    disabled={!canCompare || metricsStatus === "loading"}
                    className={
                      "px-5 py-2.5 rounded-full text-sm font-semibold flex items-center justify-center gap-2 " +
                      (canCompare
                        ? "bg-slate-900 text-white hover:bg-black"
                        : "bg-slate-200 text-slate-500 cursor-not-allowed")
                    }
                  >
                    <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/10 border border-white/40 text-[11px]">
                      1
                    </span>
                    {metricsStatus === "loading"
                      ? "Comparando datos..."
                      : "Comparativa de datos (IA)"}
                  </button>

                  <button
                    type="button"
                    onClick={handleNarrativeClick}
                    disabled={
                      !canCompare ||
                      metricsStatus !== "success" ||
                      narrativeStatus === "loading"
                    }
                    className={
                      "px-5 py-2.5 rounded-full text-sm font-semibold flex items-center justify-center gap-2 " +
                      (canCompare && metricsStatus === "success"
                        ? "bg-amber-100 text-amber-900 border border-amber-300 hover:bg-amber-200"
                        : "bg-slate-200 text-slate-500 cursor-not-allowed")
                    }
                  >
                    <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/40 border border-white/60 text-[11px]">
                      2
                    </span>
                    {narrativeStatus === "loading"
                      ? "Pidiendo opini√≥n al Lama..."
                      : "Opini√≥n final (IA)"}
                  </button>
                </div>
              </section>

              {/* Resultados comparativa de datos */}
              <section className="space-y-6">
                {metricsStatus === "loading" && (
                  <div className="bg-white border border-slate-200 rounded-2xl p-6 text-sm text-slate-600 text-center fade-in">
                    Analizando rese√±as, distribuci√≥n de estrellas y probabilidad
                    de chasco...
                  </div>
                )}

                {metricsStatus === "error" && (
                  <div className="bg-red-50 border border-red-200 rounded-2xl p-6 text-sm text-red-700 fade-in">
                    Ha habido un problema con la comparativa de datos:{" "}
                    {metricsError}
                  </div>
                )}

                {metricsStatus === "success" && metricsData && (
                  <>
                    {metricsData.analysis && (
                      <div className="bg-white border border-slate-200 rounded-2xl p-6 text-sm text-slate-700 fade-in">
                        <h2 className="font-semibold text-slate-900 mb-2">
                          Resumen r√°pido de la IA
                        </h2>
                        <p className="whitespace-pre-line">
                          {metricsData.analysis}
                        </p>
                      </div>
                    )}

                    <div className="grid md:grid-cols-2 gap-4 fade-in">
                      {[metricsData.productA, metricsData.productB].map(
                        (p, idx) => (
                          <div
                            key={p.asin}
                            className="bg-white border border-slate-200 rounded-2xl p-5 text-sm flex flex-col"
                          >
                            <div className="flex justify-between items-start mb-3">
                              <div className="text-xs uppercase font-semibold text-slate-500 tracking-wide">
                                {idx === 0 ? "Producto A" : "Producto B"}
                              </div>
                              <div className="text-xs text-slate-500">
                                {p.market} ¬∑ {p.categoria_inferida}
                              </div>
                            </div>
                            <div className="font-semibold text-slate-900 mb-1">
                              {p.nombre_producto}
                            </div>
                            <div className="text-xs text-slate-500 mb-2">
                              ASIN: {p.asin}
                            </div>
                            <div className="flex items-center gap-3 text-xs text-slate-700 mb-2">
                              <span className="font-semibold">
                                {p.mean_stars?.toFixed
                                  ? p.mean_stars.toFixed(1)
                                  : p.mean_stars}{" "}
                                ‚òÖ
                              </span>
                              <span className="text-slate-500">
                                {p.n_reviews &&
                                  `${p.n_reviews.toLocaleString(
                                    "es-ES"
                                  )} rese√±as`}
                              </span>
                            </div>
                            <div className="flex flex-wrap items-center gap-2 text-[11px] text-slate-500 mb-2">
                              {p.lama_lb95 != null &&
                                p.lama_ub95 != null && (
                                  <span>
                                    IC95% Lama: {p.lama_lb95.toFixed(2)}‚Äì{" "}
                                    {p.lama_ub95.toFixed(2)}
                                  </span>
                                )}
                              {p.prob_chasco != null && (
                                <span>
                                  ¬∑ Prob. chasco:{" "}
                                  {(p.prob_chasco * 100).toFixed(0)}%
                                </span>
                              )}
                              {p.fecha_ultima_review && (
                                <span>
                                  ¬∑ √öltima rese√±a: {p.fecha_ultima_review}
                                </span>
                              )}
                            </div>

                            <div className="mt-3">
                              <h3 className="text-xs font-semibold text-slate-800 mb-1">
                                Distribuci√≥n de estrellas
                              </h3>
                              <StarsRow product={p} />
                            </div>

                            <div className="mt-3">
                              <h3 className="text-xs font-semibold text-emerald-800 mb-1">
                                Lo que m√°s suele gustar
                              </h3>
                              <BulletList items={p.top_pros} tone="good" />
                            </div>

                            <div className="mt-3 mb-4">
                              <h3 className="text-xs font-semibold text-rose-800 mb-1">
                                Lo que suele dar problemas
                              </h3>
                              <BulletList items={p.top_contras} tone="bad" />
                            </div>

                            {/* CTA compra */}
                            <div className="mt-auto pt-2">
                              <a
                                href={`https://thelamanest.com/es-${p.asin}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="inline-flex items-center justify-center px-4 py-2 rounded-full bg-amber-600 hover:bg-amber-700 text-white text-xs font-semibold transition-colors"
                              >
                                {idx === 0
                                  ? "Comprar producto A"
                                  : "Comprar producto B"}
                              </a>
                            </div>
                          </div>
                        )
                      )}
                    </div>
                  </>
                )}

                {/* Opini√≥n final IA sobre blogs */}
                {narrativeStatus === "loading" && (
                  <div className="bg-white border border-slate-200 rounded-2xl p-6 text-sm text-slate-700 text-center fade-in">
                    Leyendo las meta-reviews y preparando una opini√≥n final...
                  </div>
                )}

                {narrativeStatus === "error" && (
                  <div className="bg-red-50 border border-red-200 rounded-2xl p-6 text-sm text-red-700 fade-in">
                    Ha habido un problema con la opini√≥n final de la IA:{" "}
                    {narrativeError}
                  </div>
                )}

                {narrativeStatus === "success" && narrativeText && (
                  <div className="bg-amber-50 border border-amber-200 rounded-2xl p-6 text-sm text-slate-800 fade-in">
                    <h2 className="font-semibold text-slate-900 mb-2">
                      Opini√≥n final de la IA Lama
                    </h2>
                    <p className="whitespace-pre-line">{narrativeText}</p>
                  </div>
                )}
              </section>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
